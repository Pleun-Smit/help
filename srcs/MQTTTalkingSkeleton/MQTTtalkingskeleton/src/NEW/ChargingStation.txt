#include <WiFi.h>
#include <PubSubClient.h>

const char* ssid = "EV-CHARGING";
const char* password = "TestTest";
const char* mqtt_server = "192.168.137.1";

WiFiClient espClient;
PubSubClient client(espClient);

String stationMode = "STATIC";
int stationId = 1; // Change per station

void callback(char* topic, byte* payload, unsigned int length);
void reconnect();


void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) delay(500);

  client.setServer(mqtt_server, 1883);
  client.setCallback(callback);
}

void loop() {
  if (!client.connected()) reconnect();
  client.loop();

  static unsigned long lastPublish = 0;
  if (millis() - lastPublish > 2000) {
    lastPublish = millis();
    String payload = "{\"alive\":true,\"power\":5,\"mode\":\"" + stationMode + "\"}";
    String topic = "station/" + String(stationId) + "/status";
    client.publish(topic.c_str(), payload.c_str());
  }
}

void callback(char* topic, byte* payload, unsigned int length) {
  String t = String(topic);
  if (t == "station/" + String(stationId) + "/mode") {
    String msg;
    for (int i = 0; i < length; i++) msg += (char)payload[i];
    stationMode = msg; // Expect {"mode":"DYNAMIC"}
  }
}

void reconnect() {
  while (!client.connected()) {
    if (client.connect(("Station" + String(stationId)).c_str())) {
      String topic = "station/" + String(stationId) + "/mode";
      client.subscribe(topic.c_str());
    } else delay(5000);
  }
}