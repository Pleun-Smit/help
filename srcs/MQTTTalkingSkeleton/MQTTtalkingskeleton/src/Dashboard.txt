#include <Arduino.h>

// Load Wi-Fi library
#include <WiFi.h>
#include "MQTTManager.h"

// Replace with your network credentials (probably going to use a phone hotspot because of eduroam)
const char* ssid = "REPLACE_WITH_YOUR_SSID";
const char* password = "REPLACE_WITH_YOUR_PASSWORD";

// Set web server port number to 80
WiFiServer server(80);

// Variable to store the HTTP request
String header;


// Current time
unsigned long currentTime = millis();
// Previous time
unsigned long previousTime = 0; 
// Define timeout time in milliseconds (example: 2000ms = 2s)
const long timeoutTime = 2000;

void setupWeb();
void Web();
void WebPageReload();


void setupWeb(){
    // Connect to Wi-Fi network with SSID and password
    Serial.print("Connecting to ");
    Serial.println(ssid);
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }
    // Print local IP address and start web server
    Serial.println("");
    Serial.println("WiFi connected.");
    Serial.println("IP address: ");
    Serial.println(WiFi.localIP());
    server.begin();
}

void Web() {
    WiFiClient client = server.available();

    if (client) {
        unsigned long currentTime = millis();
        unsigned long previousTime = currentTime;
        const unsigned long timeoutTime = 2000;

        Serial.println("New Client.");
        String header = "";
        String currentLine = "";

        while (client.connected() && (millis() - previousTime <= timeoutTime)) {
            if (client.available()) {
                char c = client.read();
                header += c;

                if (c == '\n') {
                    // Two consecutive newlines end the HTTP request
                    if (currentLine.length() == 0) {
                        // Send response header
                        client.println("HTTP/1.1 200 OK");
                        client.println("Content-type:text/html");
                        client.println("Connection: close");
                        client.println();

                        // Begin page
                        client.println("<!DOCTYPE html><html>");
                        client.println("<head><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">");
                        client.println("<style>");
                        client.println("body { font-family: Helvetica; text-align: center; }");
                        client.println(".dev { padding: 12px; margin: 10px auto; width: 250px; "
                                       "border-radius: 8px; color: white; font-size: 20px; }");
                        client.println(".on { background-color: #4CAF50; }");   // green
                        client.println(".off { background-color: #C0392B; }");  // red
                        client.println("</style>");
                        client.println("</head><body>");

                        client.println("<h1>ESP32 Device Dashboard</h1>");
                        client.println("<p>Status of connected devices via MQTT</p>");

                        // ====== DEVICE STATUS BOXES ======
                        for (auto const &entry : deviceOnline) {
                            const String &deviceName = entry.first;
                            bool isOnline = entry.second;

                            client.print("<div class='dev ");
                            client.print(isOnline ? "on" : "off");
                            client.print("'>");
                            client.print(deviceName);
                            client.print(" : ");
                            client.print(isOnline ? "ONLINE" : "OFFLINE");
                            client.println("</div>");
                        }

                        client.println("</body></html>");

                        client.println();
                        break;
                    } else {
                        currentLine = "";
                    }
                } else if (c != '\r') {
                    currentLine += c;
                }
            }
        }

        client.stop();
        Serial.println("Client disconnected.");
    }
}
